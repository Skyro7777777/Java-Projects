name: Android-AVD (API>=33) + DeepLink GUI

on:
  workflow_dispatch:

jobs:
  android-deeplink-gui:
    runs-on: windows-latest
    timeout-minutes: 3600

    env:
      # job-level environment (do NOT reference other env vars here)
      ANDROID_SDK_ROOT: C:\Android\Sdk
      ANDROID_CMDLINE_TOOLS: C:\Android\cmdline-tools
      ANDROID_API: "33"             # change to 34 or 35 if you want Android 14/15 (must be >=33)
      DEEPLINK_SETUP_URL: ${{ secrets.DEEPLINK_SETUP_URL }} # direct DeepLink installer URL stored in secrets

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Compute AVD_NAME and export it
        shell: powershell
        run: |
          $avd = "gh_avd_api_$($env:ANDROID_API)"
          echo "AVD_NAME=$avd" >> $env:GITHUB_ENV
          Write-Host "AVD_NAME set to $avd"

      - name: Enable RDP & basic firewall (so GUI session is accessible if needed)
        shell: powershell
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0 -Force
          netsh advfirewall firewall delete rule name="RDP-GHActions" || $true
          netsh advfirewall firewall add rule name="RDP-GHActions" dir=in action=allow protocol=TCP localport=3389

      - name: Create GUI user 'ghgui' (admin) and output creds to log
        shell: powershell
        run: |
          $username = "ghgui"
          $password = -join ((65..90) + (97..122) | Get-Random -Count 12 | ForEach-Object {[char]$_})
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          if (-not (Get-LocalUser -Name $username -ErrorAction SilentlyContinue)) {
            New-LocalUser -Name $username -Password $securePass -AccountNeverExpires -Description "GUI user for DeepLink session"
            Add-LocalGroupMember -Group "Administrators" -Member $username
            Add-LocalGroupMember -Group "Remote Desktop Users" -Member $username
          }
          Write-Host "GUI_USER=$username"
          Write-Host "GUI_PASS=$password"
          echo "GUI_USER=$username" >> $env:GITHUB_ENV
          echo "GUI_PASS=$password" >> $env:GITHUB_ENV

      - name: Install OpenJDK (required for Android tools)
        shell: powershell
        run: |
          choco install -y openjdk11
          java -version

      - name: Create Android SDK directories and download command-line tools
        shell: powershell
        run: |
          New-Item -ItemType Directory -Force -Path $env:ANDROID_SDK_ROOT
          New-Item -ItemType Directory -Force -Path $env:ANDROID_CMDLINE_TOOLS
          $toolsZip = "$env:TEMP\commandlinetools.zip"
          Invoke-WebRequest -Uri "https://dl.google.com/android/repository/commandlinetools-win-9477386_latest.zip" -OutFile $toolsZip -UseBasicParsing
          Expand-Archive -Path $toolsZip -DestinationPath "$env:ANDROID_SDK_ROOT\cmdline-tools" -Force
          if (-not (Test-Path "$env:ANDROID_SDK_ROOT\cmdline-tools\latest")) {
            Move-Item -Path "$env:ANDROID_SDK_ROOT\cmdline-tools\tools" -Destination "$env:ANDROID_SDK_ROOT\cmdline-tools\latest" -Force
          }
          Remove-Item $toolsZip -Force
          echo "ANDROID_SDK_ROOT=$env:ANDROID_SDK_ROOT" >> $env:GITHUB_ENV

      - name: Add Android tools to PATH
        shell: powershell
        run: |
          $new = "$env:ANDROID_SDK_ROOT\platform-tools;$env:ANDROID_SDK_ROOT\emulator;$env:ANDROID_SDK_ROOT\cmdline-tools\latest\bin"
          [Environment]::SetEnvironmentVariable("Path", $env:Path + ";" + $new, "Process")
          Write-Host "PATH updated for this job."

      - name: Install Android platform-tools, emulator, platform and system-image (API uses env variable)
        shell: powershell
        timeout-minutes: 30
        run: |
          $sdkRoot = $env:ANDROID_SDK_ROOT
          $api = $env:ANDROID_API
          $sdkmanager = "$sdkRoot\cmdline-tools\latest\bin\sdkmanager.bat"
          & $sdkmanager --sdk_root=$sdkRoot "platform-tools" "emulator" "platforms;android-$api" "system-images;android-$api;google_apis;x86_64"
          & $sdkmanager --sdk_root=$sdkRoot --licenses | ForEach-Object { $_ } 

      - name: Create AVD (force recreate if exists)
        shell: powershell
        run: |
          $sdkRoot = $env:ANDROID_SDK_ROOT
          $avdmanager = "$sdkRoot\cmdline-tools\latest\bin\avdmanager.bat"
          $api = $env:ANDROID_API
          $avdName = $env:AVD_NAME
          & $avdmanager delete avd -n $avdName | Out-Null || $true
          echo no | & $avdmanager create avd -n $avdName -k "system-images;android-$api;google_apis;x86_64" --device "pixel" --force

      - name: Start emulator (visible GUI; uses SwiftShader software GPU)
        shell: powershell
        run: |
          $sdkRoot = $env:ANDROID_SDK_ROOT
          $emulatorExe = "$sdkRoot\emulator\emulator.exe"
          $avd = $env:AVD_NAME
          Start-Process -FilePath $emulatorExe -ArgumentList "-avd",$avd,"-no-snapshot","-wipe-data","-gpu","swiftshader_indirect" -NoNewWindow
          $adb = "$sdkRoot\platform-tools\adb.exe"
          $maxWait = 600
          $elapsed = 0
          while ($elapsed -lt $maxWait) {
            $devs = & $adb devices
            if ($devs -match "emulator-") { break }
            Start-Sleep -Seconds 2
            $elapsed += 2
          }
          if ($elapsed -ge $maxWait) { Write-Error "Emulator failed to start within timeout"; exit 1 }
          $booted = $false
          $elapsed = 0
          while (-not $booted -and $elapsed -lt $maxWait) {
            $result = (& $adb -s emulator-5554 shell getprop sys.boot_completed -n 1) 2>$null
            if ($result.Trim() -eq "1") { $booted = $true; break }
            Start-Sleep -Seconds 2
            $elapsed += 2
          }
          if (-not $booted) { Write-Error "Emulator didn't finish booting in time"; exit 1 }
          & $adb devices
          echo "EMULATOR_READY=true" >> $env:GITHUB_ENV

      - name: Download & Install DeepLink (Windows) â€” requires DEEPLINK_SETUP_URL secret
        shell: powershell
        env:
          DL_URL: ${{ env.DEEPLINK_SETUP_URL }}
        run: |
          if ([string]::IsNullOrEmpty($env:DL_URL)) {
            Write-Error "DEEPLINK_SETUP_URL is empty. Please add a repository secret 'DEEPLINK_SETUP_URL' with the direct DeepLink installer URL (EXE or MSI)."
            exit 1
          }
          $out = "$env:TEMP\deeplink_setup.exe"
          Invoke-WebRequest -Uri $env:DL_URL -OutFile $out -UseBasicParsing
          Start-Process -FilePath $out -ArgumentList "/S" -Wait -NoNewWindow -ErrorAction SilentlyContinue
          Start-Sleep -Seconds 8
          Get-Process | Where-Object {$_.ProcessName -match "DeepLink"} | Select-Object ProcessName, Id | Write-Host

      - name: Print connection & control instructions (final)
        shell: powershell
        run: |
          Write-Host "=== READY ==="
          Write-Host "AVD: $env:AVD_NAME (Android API $env:ANDROID_API)"
          Write-Host "Emulator is booted: $env:EMULATOR_READY"
          Write-Host "GUI user: $env:GUI_USER"
          Write-Host "GUI pass: $env:GUI_PASS"
          Write-Host ""
          Write-Host "If DeepLink didn't auto-install, add repo secret DEEPLINK_SETUP_URL with a direct .exe/.msi link and re-run."
          while ($true) {
            Write-Host "$(Get-Date -Format 'u') - Interactive GUI job running. Cancel workflow to terminate."
            Start-Sleep -Seconds 300
          }
