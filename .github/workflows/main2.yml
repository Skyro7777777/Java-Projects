name: Android-AVD (API>=33) + DeepLink GUI

on:
  workflow_dispatch:

jobs:
  android-deeplink-gui:
    runs-on: windows-latest
    timeout-minutes: 3600

    env:
      ANDROID_SDK_ROOT: C:\Android\Sdk
      ANDROID_CMDLINE_TOOLS: C:\Android\cmdline-tools
      ANDROID_API: "33"             # change to 34 or 35 if you want Android 14/15 (must be >=33)
      AVD_NAME: "gh_avd_api_${{ env.ANDROID_API }}"
      DEEPLINK_SETUP_URL: ${{ secrets.DEEPLINK_SETUP_URL }} # (recommended) direct download URL to DeepLink Setup.exe / .msi

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Enable RDP & basic firewall (so GUI session is accessible if needed)
        shell: powershell
        run: |
          # Enable Remote Desktop
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0 -Force

          # Allow incoming RDP (port 3389) for testing (adjust if you use a VPN or other secure channel)
          netsh advfirewall firewall delete rule name="RDP-GHActions" || $true
          netsh advfirewall firewall add rule name="RDP-GHActions" dir=in action=allow protocol=TCP localport=3389

      - name: Create GUI user 'ghgui' (admin) and output creds to log
        shell: powershell
        run: |
          $username = "ghgui"
          $password = -join ((65..90) + (97..122) | Get-Random -Count 12 | ForEach-Object {[char]$_})
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          if (-not (Get-LocalUser -Name $username -ErrorAction SilentlyContinue)) {
            New-LocalUser -Name $username -Password $securePass -AccountNeverExpires -Description "GUI user for DeepLink session"
            Add-LocalGroupMember -Group "Administrators" -Member $username
            Add-LocalGroupMember -Group "Remote Desktop Users" -Member $username
          }
          Write-Host "GUI_USER=$username"
          Write-Host "GUI_PASS=$password"
          echo "GUI_USER=$username" >> $env:GITHUB_ENV
          echo "GUI_PASS=$password" >> $env:GITHUB_ENV

      - name: Install OpenJDK (required for Android tools)
        shell: powershell
        run: |
          choco install -y openjdk11
          # ensure java on path
          $env:Path = [System.Environment]::GetEnvironmentVariable("Path","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path","User")
          Write-Host "java -version:"
          java -version

      - name: Create Android SDK directories and download command-line tools
        shell: powershell
        run: |
          New-Item -ItemType Directory -Force -Path $env:ANDROID_SDK_ROOT
          New-Item -ItemType Directory -Force -Path $env:ANDROID_CMDLINE_TOOLS
          $toolsZip = "$env:TEMP\commandlinetools.zip"
          Write-Host "Downloading Android commandlinetools..."
          Invoke-WebRequest -Uri "https://dl.google.com/android/repository/commandlinetools-win-9477386_latest.zip" -OutFile $toolsZip -UseBasicParsing
          Expand-Archive -Path $toolsZip -DestinationPath "$env:ANDROID_SDK_ROOT\cmdline-tools" -Force
          # Move to "latest" folder expected by tools
          if (-not (Test-Path "$env:ANDROID_SDK_ROOT\cmdline-tools\latest")) {
            Move-Item -Path "$env:ANDROID_SDK_ROOT\cmdline-tools\tools" -Destination "$env:ANDROID_SDK_ROOT\cmdline-tools\latest" -Force
          }
          Remove-Item $toolsZip -Force
          echo "ANDROID_SDK_ROOT=$env:ANDROID_SDK_ROOT" >> $env:GITHUB_ENV

      - name: Add Android tools to PATH
        shell: powershell
        run: |
          $new = "$env:ANDROID_SDK_ROOT\platform-tools;$env:ANDROID_SDK_ROOT\emulator;$env:ANDROID_SDK_ROOT\cmdline-tools\latest\bin"
          [Environment]::SetEnvironmentVariable("Path", $env:Path + ";" + $new, "Process")
          Write-Host "PATH updated for this job."

      - name: Install Android platform-tools, emulator, platform and system-image (API ${{ env.ANDROID_API }})
        shell: powershell
        timeout-minutes: 30
        run: |
          $accept = "--sdk_root=$env:ANDROID_SDK_ROOT"
          $sdkmanager = "$env:ANDROID_SDK_ROOT\cmdline-tools\latest\bin\sdkmanager.bat"
          # Accept licenses and install required packages
          & $sdkmanager --sdk_root=$env:ANDROID_SDK_ROOT "platform-tools" "emulator" "platforms;android-${{ env.ANDROID_API }}" "system-images;android-${{ env.ANDROID_API }};google_apis;x86_64" --install
          & $sdkmanager --sdk_root=$env:ANDROID_SDK_ROOT --licenses | ForEach-Object { $_ } # accept licenses (may prompt)

      - name: Create AVD (force recreate if exists)
        shell: powershell
        run: |
          $avdmanager = "$env:ANDROID_SDK_ROOT\cmdline-tools\latest\bin\avdmanager.bat"
          # remove existing AVD if present
          & $avdmanager delete avd -n $env:AVD_NAME | Out-Null || $true
          # create new AVD; using google_apis x86_64 image
          echo no | & $avdmanager create avd -n $env:AVD_NAME -k "system-images;android-${{ env.ANDROID_API }};google_apis;x86_64" --device "pixel" --force

      - name: Start emulator (visible GUI; uses SwiftShader software GPU)
        shell: powershell
        run: |
          $emulatorExe = "$env:ANDROID_SDK_ROOT\emulator\emulator.exe"
          Write-Host "Starting emulator $env:AVD_NAME (this will run in background but GUI window is produced in the Windows session)..."
          Start-Process -FilePath $emulatorExe -ArgumentList "-avd",$env:AVD_NAME,"-no-snapshot","-wipe-data","-gpu","swiftshader_indirect" -NoNewWindow
          Write-Host "Emulator start command issued. Waiting for boot..."

          # Wait for emulator to appear and boot
          $adb = "$env:ANDROID_SDK_ROOT\platform-tools\adb.exe"
          $maxWait = 600
          $elapsed = 0
          while ($elapsed -lt $maxWait) {
            $devs = & $adb devices
            if ($devs -match "emulator-") { break }
            Start-Sleep -Seconds 2
            $elapsed += 2
          }
          if ($elapsed -ge $maxWait) { Write-Error "Emulator failed to start within timeout"; exit 1 }

          # Wait for system boot_completed
          $booted = $false
          $elapsed = 0
          while (-not $booted -and $elapsed -lt $maxWait) {
            $result = (& $adb -s emulator-5554 shell getprop sys.boot_completed -n 1) 2>$null
            if ($result.Trim() -eq "1") { $booted = $true; break }
            Start-Sleep -Seconds 2
            $elapsed += 2
          }
          if (-not $booted) { Write-Error "Emulator didn't finish booting in time"; exit 1 }
          Write-Host "Emulator is booted and ready. adb devices:"
          & $adb devices
          echo "EMULATOR_READY=true" >> $env:GITHUB_ENV

      - name: (Optional) Install an APK into emulator (example)
        if: env.EMULATOR_READY == 'true'
        shell: powershell
        run: |
          $adb = "$env:ANDROID_SDK_ROOT\platform-tools\adb.exe"
          # Example: push and install an apk in repo root named sample.apk (adjust or remove)
          if (Test-Path ".\sample.apk") {
            & $adb install -r .\sample.apk
            Write-Host "sample.apk installed"
          } else {
            Write-Host "No sample.apk found; skipping apk install"
          }

      - name: Download & Install DeepLink (Windows) â€” requires DEEPLINK_SETUP_URL secret
        shell: powershell
        env:
          DL_URL: ${{ env.DEEPLINK_SETUP_URL }}
        run: |
          if ([string]::IsNullOrEmpty($env:DL_URL)) {
            Write-Error "DEEPLINK_SETUP_URL is empty. Please add a repository secret 'DEEPLINK_SETUP_URL' with the direct DeepLink installer URL (EXE or MSI)."
            exit 1
          }
          $out = "$env:TEMP\deeplink_setup.exe"
          Write-Host "Downloading DeepLink from $env:DL_URL"
          Invoke-WebRequest -Uri $env:DL_URL -OutFile $out -UseBasicParsing
          Write-Host "Installing DeepLink silently (if supported)..."
          # Try common silent arguments; fallback to interactive if silent not supported
          Start-Process -FilePath $out -ArgumentList "/S" -Wait -NoNewWindow -ErrorAction SilentlyContinue
          Start-Sleep -Seconds 3
          if (-not (Get-Process -Name "DeepLink" -ErrorAction SilentlyContinue)) {
            # try MSI or alternate args
            & $out /quiet /norestart 2>$null || & $out /S 2>$null || Write-Host "Installer may have required interactive install (check runner logs)"
          } else {
            Write-Host "DeepLink process appears running."
          }
          # give time for GUI to initialize
          Start-Sleep -Seconds 8
          # Try to capture window title or running exe
          Get-Process | Where-Object {$_.ProcessName -match "DeepLink"} | Select-Object ProcessName, Id | Write-Host

      - name: Launch DeepLink UI (attempt) and show next steps
        shell: powershell
        run: |
          # Try to start deeplink if a known path exists (adjust if required)
          $possiblePaths = @(
            "$env:ProgramFiles\DeepLink\DeepLink.exe",
            "$env:ProgramFiles(x86)\DeepLink\DeepLink.exe",
            "$env:ProgramFiles\DeepLink\DeepLink_Setup.exe",
            "$env:ProgramFiles\DeepLink\DeepLink.exe"
          )
          $started = $false
          foreach ($p in $possiblePaths) {
            if (Test-Path $p) {
              Start-Process -FilePath $p
              Write-Host "Started DeepLink from $p"
              $started = $true
              break
            }
          }
          if (-not $started) {
            Write-Host "DeepLink executable not found in standard locations. If installer succeeded, open the runner's desktop session and start DeepLink manually. The installer page/docs show the Device ID and the hidden password (click the show icon at right to reveal password)."
          }

      - name: Print connection & control instructions (final)
        shell: powershell
        run: |
          Write-Host "=== READY ==="
          Write-Host "AVD: $env:AVD_NAME (Android API $env:ANDROID_API)"
          Write-Host "Emulator is booted: $env:EMULATOR_READY"
          Write-Host "GUI user: $env:GUI_USER"
          Write-Host "GUI pass: $env:GUI_PASS"
          Write-Host ""
          Write-Host "Next steps (on your phone):"
          Write-Host "1) Install DeepLink on your phone (Play Store)."
          Write-Host "2) On the runner's desktop session launch the DeepLink Windows client."
          Write-Host "   - The client shows Device ID and a hidden Password (click 'show password' icon on the right)."
          Write-Host "3) In the DeepLink mobile app, input the Device ID and the password to connect."
          Write-Host ""
          Write-Host "If DeepLink did not auto-install due to missing direct download URL, add a repo secret named DEEPLINK_SETUP_URL with the direct .exe/.msi download link and re-run the workflow."
          Write-Host "=============="
          # keep runner alive so you can interact via GUI (this will run until job is canceled or times out)
          Write-Host "Keeping runner alive for interactive session - workflow will print status every 5 minutes until cancelled."
          while ($true) {
            Write-Host "$(Get-Date -Format 'u') - Interactive GUI job running. Cancel workflow to terminate."
            Start-Sleep -Seconds 300
          }
