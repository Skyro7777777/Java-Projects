name: Android 15 Remote Control Environment

on:
  workflow_dispatch:

jobs:
  android-parsec-environment:
    runs-on: windows-latest
    timeout-minutes: 3600

    steps:
      - name: Setup Android SDK Environment
        shell: pwsh
        run: |
          # Create Android SDK directory
          mkdir C:\Android
          mkdir C:\Android\cmdline-tools
          $env:ANDROID_HOME = "C:\Android"
          $env:ANDROID_SDK_ROOT = "C:\Android"
          echo "ANDROID_HOME=$env:ANDROID_HOME" | Out-File -FilePath $env:GITHUB_ENV -Append
          echo "ANDROID_SDK_ROOT=$env:ANDROID_SDK_ROOT" | Out-File -FilePath $env:GITHUB_ENV -Append

          # Add Android tools to PATH
          echo "$env:ANDROID_HOME\cmdline-tools\latest\bin" | Out-File -FilePath $env:GITHUB_PATH -Append
          echo "$env:ANDROID_HOME\platform-tools" | Out-File -FilePath $env:GITHUB_PATH -Append
          echo "$env:ANDROID_HOME\emulator" | Out-File -FilePath $env:GITHUB_PATH -Append

      - name: Download Android Command-line Tools
        shell: pwsh
        run: |
          $toolsUrl = "https://dl.google.com/android/repository/commandlinetools-win-11076708_latest.zip"
          $zipPath = "$env:TEMP\cmdline-tools.zip"
          
          Invoke-WebRequest -Uri $toolsUrl -OutFile $zipPath
          Expand-Archive -Path $zipPath -DestinationPath "$env:ANDROID_HOME\cmdline-tools" -Force
          Rename-Item "$env:ANDROID_HOME\cmdline-tools\cmdline-tools" "$env:ANDROID_HOME\cmdline-tools\latest"
          Remove-Item $zipPath -Force

      - name: Install Android SDK Components
        shell: pwsh
        run: |
          # Accept licenses automatically
          $yes = "y"
          $yes | & "$env:ANDROID_HOME\cmdline-tools\latest\bin\sdkmanager.bat" --licenses --verbose
          
          # Install required components for Android 15 (API 35)
          & "$env:ANDROID_HOME\cmdline-tools\latest\bin\sdkmanager.bat" "platform-tools" "platforms;android-35" "emulator" "system-images;android-35;google_apis;x86_64" "build-tools;35.0.0" --verbose

          # Verify installation
          & "$env:ANDROID_HOME\emulator\emulator.exe" -version
          & "$env:ANDROID_HOME\platform-tools\adb.exe" version

      - name: Create Android Virtual Device
        shell: pwsh
        run: |
          # Create AVD for Android 15
          $avdName = "Android15-GUI"
          & "$env:ANDROID_HOME\cmdline-tools\latest\bin\avdmanager.bat" create avd -n $avdName -k "system-images;android-35;google_apis;x86_64" -d "pixel_6" --force
          
          # Configure AVD settings
          $avdConfig = @"
hw.device.name=pixel_6
hw.cpu.arch=x86_64
hw.ramSize=4096
hw.screen.width=1080
hw.screen.height=2400
hw.density=440
hw.gpu.enabled=yes
hw.keyboard=yes
hw.audioInput=yes
hw.audioOutput=yes
vm.heapSize=512
disk.dataPartition.size=8192M
PlayStore.enabled=0
abi.type=x86_64
image.sysdir.1=system-images\android-35\google_apis\x86_64\
"@

          $configPath = "$env:USERPROFILE\.android\avd\$avdName.avd\config.ini"
          $avdConfig | Out-File -FilePath $configPath -Encoding ASCII -Force

      - name: Install Parsec Silently
        shell: pwsh
        run: |
          # Download Parsec installer
          $parsecUrl = "https://builds.parsecgaming.com/parsec-windows.exe"
          $installerPath = "$env:TEMP\parsec-installer.exe"
          
          Invoke-WebRequest -Uri $parsecUrl -OutFile $installerPath
          
          # Install Parsec silently
          Start-Process -FilePath $installerPath -ArgumentList "/S" -Wait -NoNewWindow
          
          Remove-Item $installerPath -Force
          
          # Verify installation
          if (-not (Test-Path "${env:ProgramFiles}\Parsec\parsecd.exe")) {
            Write-Error "Parsec installation failed"
            exit 1
          }

      - name: Install Tailscale
        shell: pwsh
        run: |
          $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-1.80.0-amd64.msi"
          $installerPath = "$env:TEMP\tailscale.msi"
          
          Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath
          Start-Process msiexec.exe -ArgumentList "/i", "`"$installerPath`"", "/quiet", "/norestart" -Wait
          Remove-Item $installerPath -Force

      - name: Configure Tailscale Connection
        shell: pwsh
        run: |
          # Start Tailscale service
          Start-Service -Name "Tailscale"
          
          # Authenticate with Tailscale using secret
          & "${env:ProgramFiles}\Tailscale\tailscale.exe" up --authkey "${{ secrets.TAILSCALE_AUTH_KEY }}" --hostname "android15-runner-$env:GITHUB_RUN_ID"
          
          # Wait for IP assignment
          $tsIP = $null
          $retries = 0
          while (-not $tsIP -and $retries -lt 10) {
            $tsIP = & "${env:ProgramFiles}\Tailscale\tailscale.exe" ip -4
            Start-Sleep -Seconds 5
            $retries++
          }
          
          if (-not $tsIP) {
            Write-Error "Tailscale IP not assigned"
            exit 1
          }
          
          echo "TAILSCALE_IP=$tsIP" | Out-File -FilePath $env:GITHUB_ENV -Append
          Write-Host "Tailscale IP: $tsIP"

      - name: Start Android Emulator with GUI
        shell: pwsh
        run: |
          $avdName = "Android15-GUI"
          
          # Start emulator in background process
          Start-Process -FilePath "emulator" -ArgumentList "-avd $avdName -no-snapshot-load -gpu swiftshader_indirect -no-audio -wipe-data" -NoNewWindow
          
          # Wait for emulator to boot
          Write-Host "Waiting for Android emulator to boot..."
          Start-Sleep -Seconds 120
          
          # Verify emulator is running
          & adb devices
          $deviceCount = (& adb devices | Select-String -Pattern "device$" | Measure-Object).Count
          if ($deviceCount -eq 0) {
            Write-Error "Android emulator failed to start"
            exit 1
          }

      - name: Start Parsec Service
        shell: pwsh
        run: |
          # Start Parsec service
          $parsecPath = "${env:ProgramFiles}\Parsec\parsecd.exe"
          Start-Process -FilePath $parsecPath -NoNewWindow -PassThru
          
          Write-Host "Parsec service started successfully"
          Start-Sleep -Seconds 10

      - name: Display Connection Information
        shell: pwsh
        run: |
          Write-Host "=========================================="
          Write-Host "ANDROID 15 ENVIRONMENT READY FOR REMOTE ACCESS"
          Write-Host "=========================================="
          Write-Host "Tailscale IP: $env:TAILSCALE_IP"
          Write-Host "Environment: Android 15 (API 35)"
          Write-Host "Emulator: Pixel 6 with Google APIs"
          Write-Host ""
          Write-Host "TO CONNECT FROM YOUR ANDROID PHONE:"
          Write-Host "1. Install Parsec app from Google Play Store"
          Write-Host "2. Open Parsec app and sign in with your Parsec account"
          Write-Host "3. Connect to host using Tailscale IP: $env:TAILSCALE_IP"
          Write-Host ""
          Write-Host "The environment will remain active for up to 60 minutes"
          Write-Host "or until you cancel this workflow manually."
          Write-Host "=========================================="

      - name: Keep Session Alive
        shell: pwsh
        run: |
          Write-Host "Maintaining active session for remote access..."
          Write-Host "Session will remain active for 60 minutes"
          
          # Keep the session alive with periodic status updates
          $endTime = (Get-Date).AddMinutes(59)
          while ((Get-Date) -lt $endTime) {
            # Check if emulator is still running
            $deviceCount = (& adb devices | Select-String -Pattern "device$" | Measure-Object).Count
            
            if ($deviceCount -eq 0) {
              Write-Warning "Android emulator stopped. Attempting to restart..."
              $avdName = "Android15-GUI"
              Start-Process -FilePath "emulator" -ArgumentList "-avd $avdName -gpu swiftshader_indirect -no-audio" -NoNewWindow
              Start-Sleep -Seconds 60
            }
            
            # Check if Parsec is still running
            $parsecProcess = Get-Process -Name "parsecd" -ErrorAction SilentlyContinue
            if (-not $parsecProcess) {
              Write-Warning "Parsec service stopped. Restarting..."
              $parsecPath = "${env:ProgramFiles}\Parsec\parsecd.exe"
              Start-Process -FilePath $parsecPath -NoNewWindow -PassThru
              Start-Sleep -Seconds 10
            }
            
            Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Session active - Environment running"
            Start-Sleep -Seconds 60
          }
          
          Write-Host "Session duration reached. Workflow will terminate shortly."
