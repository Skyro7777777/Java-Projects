name: Android Parsec Control

on:
  workflow_dispatch:

jobs:
  android-parsec:
    runs-on: windows-latest
    timeout-minutes: 3600

    steps:
      - name: Configure Core RDP Settings
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0 -Force
          netsh advfirewall firewall delete rule name="RDP-Tailscale"
          netsh advfirewall firewall add rule name="RDP-Tailscale" dir=in action=allow protocol=TCP localport=3389
          Restart-Service -Name TermService -Force

      - name: Create RDP User with Secure Password
        run: |
          Add-Type -AssemblyName System.Security
          $charSet = @{
              Upper   = 65..90 | ForEach-Object { [char]$_ }
              Lower   = 97..122 | ForEach-Object { [char]$_ }
              Number  = 48..57 | ForEach-Object { [char]$_ }
              Special = 33,35,36,37,42,43,44,45,46,47,64,91,92,93,94,95,123,124,125,126 | ForEach-Object { [char]$_ }
          }
          $rawPassword = @()
          $rawPassword += Get-Random -InputObject $charSet.Upper -Count 4
          $rawPassword += Get-Random -InputObject $charSet.Lower -Count 4
          $rawPassword += Get-Random -InputObject $charSet.Number -Count 4
          $rawPassword += Get-Random -InputObject $charSet.Special -Count 4
          $password = -join ($rawPassword | Sort-Object { Get-Random })
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          New-LocalUser -Name "RDP" -Password $securePass -AccountNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member "RDP"
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "RDP"
          echo "RDP_PASSWORD=$password" >> $env:GITHUB_ENV

      - name: Install Tailscale
        run: |
          $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
          $installerPath = "$env:TEMP\tailscale.msi"
          Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath
          Start-Process msiexec.exe -ArgumentList "/i", "`"$installerPath`"", "/quiet", "/norestart" -Wait
          Remove-Item $installerPath -Force

      - name: Establish Tailscale Connection
        run: |
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-runner-$env:GITHUB_RUN_ID
          $tsIP = $null
          $retries = 0
          while (-not $tsIP -and $retries -lt 10) {
              $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
              Start-Sleep -Seconds 5
              $retries++
          }
          if (-not $tsIP) { Write-Error "Tailscale IP not assigned."; exit 1 }
          echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV

      - name: Setup Android SDK Command Line Tools
        run: |
          New-Item -ItemType Directory -Force -Path "C:\Android"
          $url = "https://dl.google.com/android/repository/commandlinetools-win-11076708_latest.zip"
          $zipPath = "$env:TEMP\cmdtools.zip"
          Invoke-WebRequest -Uri $url -OutFile $zipPath
          Expand-Archive -Path $zipPath -DestinationPath "C:\Android\cmdline-tools" -Force
          Move-Item "C:\Android\cmdline-tools\cmdline-tools" "C:\Android\cmdline-tools\latest" -Force
          $env:ANDROID_HOME = "C:\Android"
          echo "ANDROID_HOME=C:\Android" >> $env:GITHUB_ENV
          echo "C:\Android\cmdline-tools\latest\bin;C:\Android\emulator;C:\Android\platform-tools" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Install Android 15 Components
        run: |
          sdkmanager --sdk_root=$env:ANDROID_HOME --licenses
          sdkmanager --sdk_root=$env:ANDROID_HOME "platforms;android-35" "emulator" "platform-tools" "system-images;android-35;google_apis;x86_64"
          avdmanager create avd --name android15 --package "system-images;android-35;google_apis;x86_64" --force

      - name: Install Parsec
        run: |
          $parsecUrl = "https://builds.parsec.app/package/parsec-windows.exe"
          $installerPath = "$env:TEMP\parsec.exe"
          Invoke-WebRequest -Uri $parsecUrl -OutFile $installerPath
          Start-Process -FilePath $installerPath -ArgumentList "/S" -Wait
          Remove-Item $installerPath -Force

      - name: Export Parsec Secrets to Env
        run: |
          echo "PARSEC_EMAIL=${{ secrets.PARSEC_EMAIL }}" >> $env:GITHUB_ENV
          echo "PARSEC_PASSWORD=${{ secrets.PARSEC_PASSWORD }}" >> $env:GITHUB_ENV

      - name: Automate Parsec Login & Launch Android 15 Emulator
        shell: powershell
        run: |
          $user = "RDP"
          $pass = ConvertTo-SecureString $env:RDP_PASSWORD -AsPlainText -Force
          $cred = New-Object System.Management.Automation.PSCredential ($user, $pass)
          
          $script = @'
          Add-Type -AssemblyName System.Windows.Forms
          Add-Type @"
          using System;
          using System.Runtime.InteropServices;
          public class Win32 {
              [DllImport("user32.dll")] public static extern bool SetForegroundWindow(IntPtr hWnd);
              [DllImport("user32.dll")] public static extern bool EnumWindows(EnumWindowsProc p, IntPtr l);
              public delegate bool EnumWindowsProc(IntPtr hWnd, int lParam);
              [DllImport("user32.dll")] public static extern int GetWindowText(IntPtr hWnd, System.Text.StringBuilder t, int c);
              [DllImport("user32.dll")] public static extern int GetWindowTextLength(IntPtr hWnd);
          }
          "@
          function Find-Window($p) {
              $titles = @(); $len = 0; $enumProc = { param($h, $l) $len = [Win32]::GetWindowTextLength($h); if ($len -gt 0) { $b = New-Object System.Text.StringBuilder($len + 1); [Win32]::GetWindowText($h, $b, $b.Capacity) | Out-Null; if ($b.ToString() -like "*$p*") { $titles += $h } }; $true }; [Win32]::EnumWindows($enumProc, [IntPtr]::Zero) | Out-Null; return $titles
          }
          Start-Process "C:\Program Files\Parsec\parsecd.exe"
          Start-Sleep 15
          $parsecHwnds = Find-Window "Parsec"
          if ($parsecHwnds) { [Win32]::SetForegroundWindow($parsecHwnds[0]); Start-Sleep 3; [System.Windows.Forms.SendKeys]::SendWait("$env:PARSEC_EMAIL{TAB}$env:PARSEC_PASSWORD{ENTER}"); Start-Sleep 15 }
          $emulatorPath = "$env:ANDROID_HOME\emulator\emulator.exe"
          if (Test-Path $emulatorPath) { Start-Process $emulatorPath -ArgumentList "-avd", "android15" -WindowStyle Maximized; Start-Sleep 180 }
          Start-Sleep 60
          '@
          $script | Out-File "$env:TEMP\automate.ps1" -Encoding UTF8
          Start-Process powershell.exe -Credential $cred -ArgumentList "-ExecutionPolicy", "Bypass", "-File", "$env:TEMP\automate.ps1" -Wait

      - name: Verify RDP
        run: |
          $t = Test-NetConnection $env:TAILSCALE_IP -Port 3389
          if (!$t.TcpTestSucceeded) { Write-Error "RDP port closed"; exit 1 }

      - name: Keep Alive
        run: |
          Write-Host "=== CONNECT ==="
          Write-Host "Tailscale IP: $env:TAILSCALE_IP"
          Write-Host "RDP: RDP / $env:RDP_PASSWORD"
          Write-Host "Parsec: Logged in - Connect from app to host 'gh-runner-$env:GITHUB_RUN_ID' (Android 15 home screen ready)"
          while ($true) { Write-Host "[$(Get-Date)] Active"; Start-Sleep 300 }
