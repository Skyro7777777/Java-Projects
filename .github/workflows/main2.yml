name: Android Parsec Control

on:
  workflow_dispatch:

jobs:
  android-parsec:
    runs-on: windows-latest
    timeout-minutes: 3600

    steps:
      - name: Configure Core RDP Settings
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0 -Force
          netsh advfirewall firewall delete rule name="RDP-Tailscale"
          netsh advfirewall firewall add rule name="RDP-Tailscale" dir=in action=allow protocol=TCP localport=3389
          Restart-Service -Name TermService -Force

      - name: Create RDP User with Secure Password
        run: |
          Add-Type -AssemblyName System.Security
          $charSet = @{
              Upper   = 65..90 | ForEach-Object { [char]$_ }
              Lower   = 97..122 | ForEach-Object { [char]$_ }
              Number  = 48..57 | ForEach-Object { [char]$_ }
              Special = 33,35,36,37,42,43,44,45,46,47,64,91,92,93,94,95,123,124,125,126 | ForEach-Object { [char]$_ }
          }
          $rawPassword = @()
          $rawPassword += Get-Random -InputObject $charSet.Upper -Count 4
          $rawPassword += Get-Random -InputObject $charSet.Lower -Count 4
          $rawPassword += Get-Random -InputObject $charSet.Number -Count 4
          $rawPassword += Get-Random -InputObject $charSet.Special -Count 4
          $password = -join ($rawPassword | Sort-Object { Get-Random })
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          New-LocalUser -Name "RDP" -Password $securePass -AccountNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member "RDP"
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "RDP"
          echo "RDP_PASSWORD=$password" >> $env:GITHUB_ENV

      - name: Install Tailscale
        run: |
          $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
          $installerPath = "$env:TEMP\tailscale.msi"
          Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath
          Start-Process msiexec.exe -ArgumentList "/i", "`"$installerPath`"", "/quiet", "/norestart" -Wait
          Remove-Item $installerPath -Force

      - name: Establish Tailscale Connection
        run: |
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-runner-$env:GITHUB_RUN_ID
          $tsIP = $null
          $retries = 0
          while (-not $tsIP -and $retries -lt 10) {
              $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
              Start-Sleep -Seconds 5
              $retries++
          }
          if (-not $tsIP) { Write-Error "Tailscale IP not assigned."; exit 1 }
          echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV

      - name: Install BlueStacks (Android 15)
        run: |
          $bsUrl = "https://data1.bluestacks.com/BluestacksFullInstaller_native.exe"
          $installerPath = "$env:TEMP\bluestacks.exe"
          Invoke-WebRequest -Uri $bsUrl -OutFile $installerPath
          Start-Process -FilePath $installerPath -ArgumentList "/S", "/NOLAUNCH" -Wait
          Remove-Item $installerPath -Force

      - name: Install Parsec
        run: |
          $parsecUrl = "https://builds.parsec.app/package/parsec-windows.exe"
          $installerPath = "$env:TEMP\parsec.exe"
          Invoke-WebRequest -Uri $parsecUrl -OutFile $installerPath
          Start-Process -FilePath $installerPath -ArgumentList "/S" -Wait
          Remove-Item $installerPath -Force

      - name: Export Parsec Secrets to Env
        run: |
          echo "PARSEC_EMAIL=${{ secrets.PARSEC_EMAIL }}" >> $env:GITHUB_ENV
          echo "PARSEC_PASSWORD=${{ secrets.PARSEC_PASSWORD }}" >> $env:GITHUB_ENV

      - name: Automate Parsec Login & Launch Android
        shell: powershell
        run: |
          $user = "RDP"
          $pass = ConvertTo-SecureString $env:RDP_PASSWORD -AsPlainText -Force
          $cred = New-Object System.Management.Automation.PSCredential ($user, $pass)
          
          $script = @'
          Add-Type -AssemblyName System.Windows.Forms
          Add-Type @'
          using System;
          using System.Runtime.InteropServices;
          public class Win32 {
              [DllImport("user32.dll")] public static extern bool SetForegroundWindow(IntPtr hWnd);
              [DllImport("user32.dll")] public static extern bool EnumWindows(EnumWindowsProc p, IntPtr l);
              public delegate bool EnumWindowsProc(IntPtr hWnd, int lParam);
              [DllImport("user32.dll")] public static extern int GetWindowText(IntPtr hWnd, System.Text.StringBuilder t, int c);
              [DllImport("user32.dll")] public static extern int GetWindowTextLength(IntPtr hWnd);
          }
          '@
          function Find-Window($p) {
              $t = @(); $e = { param($h,$l) $l = [Win32]::GetWindowTextLength($h); if($l){$b=New-Object Text.StringBuilder ($l+1); [Win32]::GetWindowText($h,$b,$b.Capacity)|Out-Null; if($b.ToString()-like "*$p*"){$t+=$h}} $true }
              [Win32]::EnumWindows($e,[IntPtr]::Zero)|Out-Null; return $t
          }
          Start-Process "C:\Program Files\Parsec\parsecd.exe"
          Start-Sleep 15
          $hw = Find-Window "Parsec"
          if($hw){ [Win32]::SetForegroundWindow($hw[0]); Start-Sleep 2; [System.Windows.Forms.SendKeys]::SendWait("$env:PARSEC_EMAIL{TAB}$env:PARSEC_PASSWORD{ENTER}") }
          Start-Sleep 10
          $bs = "C:\Program Files\BlueStacks_nxt\HD-Player.exe"
          if(Test-Path $bs){ Start-Process $bs -ArgumentList "--instance","Pie64" -WindowStyle Maximized; Start-Sleep 30; [System.Windows.Forms.SendKeys]::SendWait("{F11}") }
          Start-Sleep 60
          '@
          $script | Out-File "$env:TEMP\a.ps1" -Encoding UTF8
          Start-Process powershell -Credential $cred -ArgumentList "-NoProfile","-ExecutionPolicy","Bypass","-File","$env:TEMP\a.ps1" -Wait

      - name: Verify RDP
        run: |
          $t = Test-NetConnection $env:TAILSCALE_IP -Port 3389
          if(!$t.TcpTestSucceeded){ Write-Error "RDP port closed"; exit 1 }

      - name: Keep Alive
        run: |
          Write-Host "=== CONNECT ==="
          Write-Host "Tailscale IP: $env:TAILSCALE_IP"
          Write-Host "RDP: RDP / $env:RDP_PASSWORD"
          Write-Host "Parsec: Host 'gh-runner-$env:GITHUB_RUN_ID' (logged in)"
          Write-Host "Android 15 GUI running in BlueStacks"
          while($true){ Write-Host "[$(Get-Date)] Active"; Start-Sleep 300 }
