name: Android 15 GUI Environment with Parsec

on:
  workflow_dispatch:

jobs:
  android-parsec-environment:
    runs-on: windows-latest
    timeout-minutes: 3600

    steps:
      - name: Configure System for Android SDK
        run: |
          # Create Android SDK directory without spaces in path
          mkdir C:\Android
          mkdir C:\Android\android-sdk
          $env:ANDROID_SDK_ROOT = "C:\Android\android-sdk"
          $env:ANDROID_HOME = "C:\Android\android-sdk"
          echo "ANDROID_SDK_ROOT=$env:ANDROID_SDK_ROOT" >> $env:GITHUB_ENV
          echo "ANDROID_HOME=$env:ANDROID_HOME" >> $env:GITHUB_ENV
          
          # Add to PATH
          $env:PATH = "$env:ANDROID_SDK_ROOT\tools;$env:ANDROID_SDK_ROOT\tools\bin;$env:ANDROID_SDK_ROOT\platform-tools;$env:PATH"
          echo "$env:ANDROID_SDK_ROOT\tools" >> $env:GITHUB_PATH
          echo "$env:ANDROID_SDK_ROOT\tools\bin" >> $env:GITHUB_PATH
          echo "$env:ANDROID_SDK_ROOT\platform-tools" >> $env:GITHUB_PATH

      - name: Download Android SDK Command-line Tools
        run: |
          $sdkToolsUrl = "https://dl.google.com/android/repository/commandlinetools-win-11076708_latest.zip"
          $zipPath = "$env:TEMP\cmdline-tools.zip"
          $toolsDir = "$env:ANDROID_SDK_ROOT\tools"
          
          Invoke-WebRequest -Uri $sdkToolsUrl -OutFile $zipPath
          Expand-Archive -Path $zipPath -DestinationPath $toolsDir -Force
          Remove-Item $zipPath -Force
          
          # Rename the extracted folder to avoid path issues
          if (Test-Path "$toolsDir\cmdline-tools") {
            Move-Item "$toolsDir\cmdline-tools" "$toolsDir\latest"
          }

      - name: Install Android SDK Components
        run: |
          # Accept licenses first
          $yes = "y"
          $yes | & "$env:ANDROID_SDK_ROOT\tools\bin\sdkmanager.bat" --licenses --verbose
          
          # Install required components for Android 15 (API 35)
          & "$env:ANDROID_SDK_ROOT\tools\bin\sdkmanager.bat" "platform-tools" "platforms;android-35" "emulator" "system-images;android-35;google_apis;x86_64" "build-tools;35.0.0" --verbose

      - name: Create Android Virtual Device
        run: |
          # Create AVD for Android 15
          $avdName = "Android15-GUI"
          $sdkPath = $env:ANDROID_SDK_ROOT
          
          & "$sdkPath\tools\bin\avdmanager.bat" create avd `
            -n $avdName `
            -k "system-images;android-35;google_apis;x86_64" `
            -d "pixel_6" `
            --force
          
          # Configure AVD for better performance
          $avdConfig = @"
          hw.device.name=pixel_6
          hw.cpu.arch=x86_64
          hw.ramSize=4096
          hw.screen.width=1080
          hw.screen.height=2400
          hw.density=440
          hw.gpu.enabled=yes
          hw.gpu.mode=auto
          hw.keyboard=yes
          hw.audioInput=yes
          hw.audioOutput=yes
          hw.camera.back=none
          hw.camera.front=none
          vm.heapSize=512
          disk.dataPartition.size=8192M
          skin.name=1080x2400
          skin.path=$sdkPath\skins\pixel_6
          PlayStore.enabled=0
          abi.type=x86_64
          image.sysdir.1=system-images\android-35\google_apis\x86_64\
"@
          
          $avdConfig | Out-File -FilePath "$env:USERPROFILE\.android\avd\$avdName.avd\config.ini" -Encoding ASCII -Force

      - name: Install Parsec Silently
        run: |
          # Download Parsec installer
          $parsecUrl = "https://builds.parsecgaming.com/parsec-windows.exe"
          $installerPath = "$env:TEMP\parsec-installer.exe"
          
          Invoke-WebRequest -Uri $parsecUrl -OutFile $installerPath
          
          # Install Parsec silently with team configuration
          # /S for silent install, /team_id for team configuration
          Start-Process -FilePath $installerPath -ArgumentList "/S" -Wait -NoNewWindow
          
          Remove-Item $installerPath -Force
          
          # Verify installation
          $parsecPath = "${env:ProgramFiles}\Parsec\parsecd.exe"
          if (-not (Test-Path $parsecPath)) {
            Write-Error "Parsec installation failed"
            exit 1
          }

      - name: Install Tailscale
        run: |
          $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
          $installerPath = "$env:TEMP\tailscale.msi"
          
          Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath
          Start-Process msiexec.exe -ArgumentList "/i", "`"$installerPath`"", "/quiet", "/norestart" -Wait
          Remove-Item $installerPath -Force

      - name: Configure Tailscale Connection
        run: |
          # Start Tailscale service
          Start-Service -Name "Tailscale"
          
          # Authenticate with Tailscale
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey="${{ secrets.TAILSCALE_AUTH_KEY }}" --hostname="android15-runner-$env:GITHUB_RUN_ID"
          
          # Wait for IP assignment
          $tsIP = $null
          $retries = 0
          while (-not $tsIP -and $retries -lt 10) {
            $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
            Start-Sleep -Seconds 5
            $retries++
          }
          
          if (-not $tsIP) {
            Write-Error "Tailscale IP not assigned"
            exit 1
          }
          
          echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV

      - name: Start Android Emulator with GUI
        run: |
          # Start emulator in separate process with GUI
          $avdName = "Android15-GUI"
          $emulatorPath = "$env:ANDROID_SDK_ROOT\emulator\emulator.exe"
          
          # Start emulator with GUI enabled
          Start-Process -FilePath $emulatorPath -ArgumentList "-avd $avdName -no-snapshot-load -gpu swiftshader_indirect -no-audio -wipe-data" -NoNewWindow
          
          # Wait for emulator to boot
          Write-Host "Waiting for Android emulator to boot..."
          Start-Sleep -Seconds 60

      - name: Start Parsec Service
        run: |
          # Start Parsec service
          $parsecService = "${env:ProgramFiles}\Parsec\parsecd.exe"
          Start-Process -FilePath $parsecService -NoNewWindow -PassThru
          
          Write-Host "Parsec service started"
          Start-Sleep -Seconds 10

      - name: Display Connection Information
        run: |
          Write-Host "=========================================="
          Write-Host "ANDROID 15 ENVIRONMENT READY FOR REMOTE ACCESS"
          Write-Host "=========================================="
          Write-Host "Tailscale IP: $env:TAILSCALE_IP"
          Write-Host "Environment: Android 15 (API 35)"
          Write-Host "Emulator: Pixel 6 with Google APIs"
          Write-Host ""
          Write-Host "TO CONNECT REMOTELY:"
          Write-Host "1. Install Parsec app on your Android phone"
          Write-Host "2. Open Parsec app and sign in with your Parsec account"
          Write-Host "3. Connect to host with Tailscale IP: $env:TAILSCALE_IP"
          Write-Host ""
          Write-Host "NOTE: The environment will remain active for up to 60 minutes"
          Write-Host "or until you cancel this workflow manually."
          Write-Host "=========================================="

      - name: Keep Session Alive
        run: |
          Write-Host "Maintaining active session for remote access..."
          Write-Host "Press Ctrl+C in GitHub Actions to terminate this workflow early"
          
          # Keep the session alive by periodically checking emulator and Parsec status
          while ($true) {
            # Check if emulator is still running
            $emulatorProcess = Get-Process -Name "emulator*" -ErrorAction SilentlyContinue
            if (-not $emulatorProcess) {
              Write-Warning "Android emulator stopped. Attempting to restart..."
              $avdName = "Android15-GUI"
              $emulatorPath = "$env:ANDROID_SDK_ROOT\emulator\emulator.exe"
              Start-Process -FilePath $emulatorPath -ArgumentList "-avd $avdName -gpu swiftshader_indirect -no-audio" -NoNewWindow
              Start-Sleep -Seconds 30
            }
            
            # Check if Parsec is still running
            $parsecProcess = Get-Process -Name "parsecd" -ErrorAction SilentlyContinue
            if (-not $parsecProcess) {
              Write-Warning "Parsec service stopped. Restarting..."
              $parsecService = "${env:ProgramFiles}\Parsec\parsecd.exe"
              Start-Process -FilePath $parsecService -NoNewWindow -PassThru
              Start-Sleep -Seconds 10
            }
            
            Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Session active - Environment running"
            Start-Sleep -Seconds 60
          }
        timeout-minutes: 3590  # Just under the job timeout to allow for cleanup
