name: GitHub RDP Server with Android Emulator & Deeplink PC Host

on:
  workflow_dispatch:

jobs:
  setup-rdp-deeplink-pc:
    runs-on: windows-latest
    timeout-minutes: 360  # ~6 hours

    steps:
    - name: Configure Core RDP Settings
      shell: powershell
      run: |
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0 -Force
        netsh advfirewall firewall delete rule name="RDP-Tailscale" 2>$null
        netsh advfirewall firewall add rule name="RDP-Tailscale" dir=in action=allow protocol=TCP localport=3389
        Restart-Service -Name TermService -Force

    - name: Create RDP User with Secure Password
      shell: powershell
      run: |
        Add-Type -AssemblyName System.Security
        $charSet = @{ Upper = [char[]](65..90); Lower = [char[]](97..122); Number = [char[]](48..57); Special = ([char[]](33..47) + [char[]](58..64) + [char[]](91..96) + [char[]](123..126)) }
        $rawPassword = @()
        $rawPassword += $charSet.Upper | Get-Random -Count 4
        $rawPassword += $charSet.Lower | Get-Random -Count 4
        $rawPassword += $charSet.Number | Get-Random -Count 4
        $rawPassword += $charSet.Special | Get-Random -Count 4
        $password = -join ($rawPassword | Sort-Object { Get-Random })
        $securePass = ConvertTo-SecureString $password -AsPlainText -Force
        New-LocalUser -Name "RDP" -Password $securePass -AccountNeverExpires
        Add-LocalGroupMember -Group "Administrators" -Member "RDP"
        Add-LocalGroupMember -Group "Remote Desktop Users" -Member "RDP"
        echo "RDP_PASSWORD=$password" >> $env:GITHUB_ENV

    - name: Install Tailscale
      shell: powershell
      run: |
        $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-1.90.6-amd64.msi"  # Update to latest
        $installerPath = "$env:TEMP\tailscale.msi"
        Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath
        Start-Process msiexec.exe -ArgumentList "/i `"$installerPath`" /quiet /norestart" -Wait
        Remove-Item $installerPath -Force

    - name: Establish Tailscale Connection
      shell: powershell
      run: |
        & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-runner-$env:GITHUB_RUN_ID
        $tsIP = $null
        $retries = 0
        while (-not $tsIP -and $retries -lt 10) {
            $tsIP = (& "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4).Trim()
            Start-Sleep -Seconds 5
            $retries++
        }
        if (-not $tsIP) { Write-Error "Tailscale IP not assigned."; exit 1 }
        echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV

    - name: Verify RDP Accessibility
      shell: powershell
      run: |
        Write-Host "Tailscale IP: $env:TAILSCALE_IP"
        $testResult = Test-NetConnection -ComputerName $env:TAILSCALE_IP -Port 3389
        if (-not $testResult.TcpTestSucceeded) { Write-Error "RDP port failed"; exit 1 }
        Write-Host "RDP ready"

    - name: Set up Android SDK and Start Emulator
      shell: powershell
      run: |
        $ANDROID_HOME = "$env:USERPROFILE\android-sdk"
        $env:ANDROID_HOME = $ANDROID_HOME
        $env:PATH += ";$ANDROID_HOME\platform-tools;$ANDROID_HOME\emulator;$ANDROID_HOME\cmdline-tools\latest\bin"
        
        # Download cmdline tools
        $cmdlineUrl = "https://dl.google.com/android/repository/commandlinetools-win-13114758_latest.zip"
        $cmdlineZip = "$env:TEMP\cmdline-tools.zip"
        Invoke-WebRequest -Uri $cmdlineUrl -OutFile $cmdlineZip
        Expand-Archive -Path $cmdlineZip -DestinationPath "$ANDROID_HOME\cmdline-tools" -Force
        Move-Item "$ANDROID_HOME\cmdline-tools\cmdline-tools" "$ANDROID_HOME\cmdline-tools\latest" -Force
        Remove-Item $cmdlineZip
        
        # Setup SDK
        & "$ANDROID_HOME\cmdline-tools\latest\bin\sdkmanager.bat" --update
        yes | & "$ANDROID_HOME\cmdline-tools\latest\bin\sdkmanager.bat" --licenses
        
        # Install Android 15 (API 35)
        & "$ANDROID_HOME\cmdline-tools\latest\bin\sdkmanager.bat" "platform-tools" "platforms;android-35" "emulator" "system-images;android-35;google_apis;x86_64"
        
        # Create AVD
        echo "no" | & "$ANDROID_HOME\cmdline-tools\latest\bin\avdmanager.bat" create avd -n android15_test -k "system-images;android-35;google_apis;x86_64" -d pixel_6
        
        # Start emulator (visible window)
        Start-Process -FilePath "$ANDROID_HOME\emulator\emulator.exe" -ArgumentList "-avd android15_test -gpu host -no-snapshot-save -m 2048 -no-boot-anim -noaudio"
        
        # Wait for boot
        $timeout = 300
        while ($timeout -gt 0) {
          $booted = & adb shell getprop sys.boot_completed 2>$null
          if ($booted -eq "1") { break }
          Start-Sleep -Seconds 10
          $timeout -= 10
        }
        adb wait-for-device
        Write-Host "Android emulator booted (visible on RDP desktop)"

    - name: Install and Launch Deeplink PC Client
      shell: powershell
      run: |
        # Download latest Windows EXE (v1.0.5.8 as of Nov 2025; update URL/version from deeplink.cloud/software)
        $deeplinkUrl = "https://dl.deeplink.cloud/DeepLink-Setup-v1.0.5.8.exe"  # Verify exact from site
        $exePath = "$env:TEMP\DeepLink-Setup.exe"
        Invoke-WebRequest -Uri $deeplinkUrl -OutFile $exePath
        Start-Process -FilePath $exePath -ArgumentList "/S" -Wait  # Silent install if supported; else /quiet
        Remove-Item $exePath
        
        # Launch Deeplink (assume installed to default path; adjust if needed)
        $deeplinkPath = "${env:ProgramFiles}\DeepLink\DeepLink.exe"  # Or search registry/start menu
        if (Test-Path $deeplinkPath) { Start-Process -FilePath $deeplinkPath }
        else { Start-Process -FilePath "DeepLink" -ErrorAction SilentlyContinue }  # Via start menu
        
        Start-Sleep -Seconds 10  # Wait for launch
        
        # Attempt auto-login (requires app window focus; brittle - adjust coords/title via RDP testing)
        Add-Type -AssemblyName System.Windows.Forms
        [System.Windows.Forms.SendKeys]::SendWait("${{ secrets.EMAIL }}{TAB}")
        Start-Sleep -Seconds 1
        [System.Windows.Forms.SendKeys]::SendWait("${{ secrets.PASSWORD }}{ENTER}")
        Write-Host "Deeplink PC client launched and login attempted. Verify via RDP if needed."

    - name: Display Access Info and Maintain Connection
      shell: powershell
      run: |
        Write-Host "`n=== ACCESS INFO ==="
        Write-Host "RDP: $env:TAILSCALE_IP:3389 | User: RDP | Pass: $env:RDP_PASSWORD"
        Write-Host "Use RDP to verify emulator/Deeplink setup (manual login if auto fails)."
        Write-Host "Mobile: Install Deeplink APK on phone, login same account, connect to this PC instance."
        Write-Host "Control PC (with Android emulator visible) from phone via Deeplink cloud relay."
        Write-Host "Install/test apps on emulator: Via RDP or adb in phone session if bridged.`n"
        
        # Keep active ~6h
        $counter = 0
        while ($counter -lt 72) {
            Write-Host "[$(Get-Date)] Active - Control from mobile Deeplink"
            Start-Sleep -Seconds 300
            $counter++
        }
